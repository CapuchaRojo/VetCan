// IMPORTANT â€” DO NOT UPGRADE PRISMA
// This project is pinned to Prisma v5.x
// Prisma v7+ removes datasource.url and will BREAK this schema
// Codex: use prisma@5.22.0 ONLY
// CI uses SQLite at file:./prisma/ci.db
// DATABASE_URL is injected by GitHub Actions

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Patient {
  id          String   @id @default(uuid())
  firstName   String
  lastName    String
  phone       String   @unique
  email       String?
  dob         DateTime?
  isVeteran   Boolean  @default(false)

  deletedAt  DateTime?
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  appointments Appointment[]
  calls        Call[]
}

model Appointment {
  id        String   @id @default(uuid())
  patientId String
  doctorId  String

  patient   Patient @relation(fields: [patientId], references: [id])

  startTime DateTime
  endTime   DateTime
  status    String   @default("SCHEDULED")

  deletedAt DateTime?
  createdAt DateTime @default(now())

  @@index([doctorId, startTime, endTime])
}

model Call {
  id        String   @id @default(uuid())

  patientId String?
  patient   Patient? @relation(fields: [patientId], references: [id])

  callSid   String?  @unique
  direction String   @default("inbound")

  startedAt DateTime?
  endedAt   DateTime?
  recording String?
  createdAt DateTime @default(now())
}

model CallbackRequest {
  id            String   @id @default(cuid())
  name          String
  phone         String

  requestType   String?
  preferredTime String?

  status        String
  source        String   @default("sms")

  // Phase 4 fields (NON-PHI)
  aiHandled             Boolean   @default(false)
  aiOutcome             String?   // "reached" | "voicemail" | "no_answer" | "failed"
  lastAttemptAt         DateTime?
  confirmedName         String?
  nonMedicalReason      String?
  staffFollowupRequired Boolean   @default(false)
  summary               String?

  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
}

model Agent {
  id        String   @id @default(uuid())
  name      String
  email     String   @unique
  role      String
  createdAt DateTime @default(now())
}

model Alert {
  id          String   @id @default(cuid())
  severity    String
  alertType   String?
  eventName   String?
  correlationId String?
  source      String?
  environment String?
  ageSeconds  Int?
  callSid     String?
  summary     String
  acknowledgedAt DateTime?
  acknowledgedBy String?
  triggeredAt DateTime @default(now())
  createdAt   DateTime @default(now())

  @@index([correlationId])
  @@index([source])
  @@unique([alertType, correlationId])
}

// ===========================
// Operational Events & Alerts
// ===========================

model OperationalEvent {
  id            String   @id @default(cuid())
  eventName     String
  severity      String?  // "info" | "warning" | "critical"
  source        String?
  correlationId String?
  environment   String

  // JSON stringified payload (SQLite-compatible)
  payload       String

  createdAt     DateTime @default(now())

  escalations   EscalationDelivery[]

  @@index([correlationId])
}

model EscalationDelivery {
  id            String   @id @default(cuid())
  eventId       String
  event         OperationalEvent @relation(fields: [eventId], references: [id])

  // Unique per delivery target + event
  dedupeKey     String   @unique

  // "pending" | "delivered" | "failed" | "canceled"
  status        String   @default("pending")

  attemptCount  Int      @default(0)
  lastAttemptAt DateTime?
  lastError     String?

  createdAt     DateTime @default(now())
  sentAt        DateTime?

  @@index([status, lastAttemptAt])
}
