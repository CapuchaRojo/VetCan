FROM node:20-bookworm

# üîë Work inside /usr/src/app/api
WORKDIR /usr/src/app/api

# 1Ô∏è‚É£ Copy package files first
COPY api/package*.json ./

# 2Ô∏è‚É£ Copy prisma schema BEFORE npm ci (critical)
COPY api/prisma ./prisma

# 3Ô∏è‚É£ Install dependencies (postinstall can now run safely)
RUN npm ci

# 4Ô∏è‚É£ Copy the rest of the source code
COPY api .

# 5Ô∏è‚É£ Clean any stale output
RUN rm -rf dist

# 6Ô∏è‚É£ Generate Prisma client (explicit, deterministic)
RUN npx prisma generate

# 7Ô∏è‚É£ Compile using *this* tsconfig.json
RUN npx tsc

ENV NODE_ENV=production

EXPOSE 4000

CMD ["node", "dist/server.js"]